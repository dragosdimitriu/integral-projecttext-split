<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integral ProjectText FileProcessor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <img src="{{ url_for('static', filename='images/logo.png') }}" 
                     onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/logo.svg') }}';" 
                     alt="SCHRACK SECONET Logo" class="logo-main">
            </div>
            <div class="header-content">
                <div class="icon-wrapper">
                    <img src="{{ url_for('static', filename='images/icon.png') }}" 
                         onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/icon.svg') }}';" 
                         alt="Icon" class="logo-icon">
                </div>
                <div class="header-text">
                    <h1>Integral ProjectText FileProcessor</h1>
                    <p class="subtitle">Process Excel files by splitting long text cells</p>
                </div>
            </div>
            {% if user %}
            <div class="user-menu">
                <div class="user-info">
                    <img src="{{ user.picture if user.picture else url_for('static', filename='images/default-avatar.svg') }}" 
                         alt="User Avatar" 
                         class="user-avatar"
                         onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/default-avatar.svg') }}';">
                    <span class="user-name">{{ user.name }}</span>
                </div>
                <a href="{{ url_for('logout') }}" class="btn btn-logout">Logout</a>
            </div>
            {% endif %}
        </header>

        <main>
            <!-- Statistics Dashboard -->
            <section class="statistics-section" id="statisticsSection">
                <h2>Processing Statistics</h2>
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-value" id="statTotalProcessed">0</div>
                        <div class="stat-label">Total Files Processed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statAvgTime">0.0s</div>
                        <div class="stat-label">Average Processing Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statSuccessRate">0%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </div>
            </section>

            <section class="upload-section">
                <h2>Upload File</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-dropzone" id="uploadDropzone">
                        <div class="upload-icon">üìÅ</div>
                        <p class="upload-text">Drag and drop Excel files here</p>
                        <p class="upload-subtext">or click to browse</p>
                        <input type="file" id="file" name="file" accept=".xlsx,.xls" multiple style="display: none;">
                    </div>
                    <div id="uploadProgressContainer" style="display: none;">
                        <div class="upload-progress-list" id="uploadProgressList"></div>
                    </div>
                </div>
                <form id="uploadForm" enctype="multipart/form-data" style="display: none;">
                </form>
                <p class="form-hint">After uploading, set the column and max characters for each file before processing.</p>
            </section>

            <section class="files-section" id="uploadedFilesSection" style="display: none;">
                <h2>Uploaded Files</h2>
                <div id="uploadedFilesList"></div>
                <button id="showMoreUploaded" class="btn btn-show-more" style="display: none;" onclick="toggleUploadedFiles()">Show More</button>
            </section>

            <section class="files-section" id="outputFilesSection" style="display: none;">
                <h2>Generated Output</h2>
                <div id="outputFilesList"></div>
                <button id="showMoreOutput" class="btn btn-show-more" style="display: none;" onclick="toggleOutputFiles()">Show More</button>
            </section>

            <!-- Help Section -->
            <section class="help-section" id="helpSection">
                <h2>
                    Help & FAQ
                    <button class="btn-help-toggle" onclick="toggleHelp()">‚àí</button>
                </h2>
                <div class="help-content" id="helpContent">
                    <div class="help-tabs">
                        <button class="help-tab active" onclick="showHelpTab('faq')">FAQ</button>
                        <button class="help-tab" onclick="showHelpTab('tutorial')">Tutorial</button>
                    </div>
                    
                    <div class="help-tab-content active" id="helpFaq">
                        <div class="faq-item">
                            <h3 class="faq-question" onclick="toggleFaq(this)">What file formats are supported? <span class="faq-toggle">+</span></h3>
                            <div class="faq-answer">The application supports Excel files in .xlsx and .xls formats. Files must contain exactly one sheet with data in only one column.</div>
                        </div>
                        <div class="faq-item">
                            <h3 class="faq-question" onclick="toggleFaq(this)">What are the file requirements? <span class="faq-toggle">+</span></h3>
                            <div class="faq-answer">Your Excel file must have: (1) Exactly one sheet, (2) Data in only one column, (3) Maximum file size of 16MB. The application will automatically validate your file before processing.</div>
                        </div>
                        <div class="faq-item">
                            <h3 class="faq-question" onclick="toggleFaq(this)">How does the text splitting work? <span class="faq-toggle">+</span></h3>
                            <div class="faq-answer">The application splits long text cells at the last space before the maximum character limit. The remaining text is moved to the next column. This process continues until all cells are within the specified limit.</div>
                        </div>
                        <div class="faq-item">
                            <h3 class="faq-question" onclick="toggleFaq(this)">What if I enter wrong parameters? <span class="faq-toggle">+</span></h3>
                            <div class="faq-answer">No problem! You can adjust the column and max characters for any uploaded file without re-uploading. Just change the values and click Process again.</div>
                        </div>
                        <div class="faq-item">
                            <h3 class="faq-question" onclick="toggleFaq(this)">How do I know which column to use? <span class="faq-toggle">+</span></h3>
                            <div class="faq-answer">When you upload a file, the application automatically detects which column has data and suggests it. You can also use the Preview button to see your file structure before processing.</div>
                        </div>
                        <div class="faq-item">
                            <h3 class="faq-question" onclick="toggleFaq(this)">What is the maximum character limit? <span class="faq-toggle">+</span></h3>
                            <div class="faq-answer">The maximum characters per cell should ideally be between 18 and 20 characters, and should not exceed 23 characters. The application will automatically suggest 20 characters when you upload a file, which is the optimal value for most use cases.</div>
                        </div>
                    </div>
                    
                    <div class="help-tab-content" id="helpTutorial">
                        <div class="tutorial-step">
                            <h3>Step 1: Upload Your File</h3>
                            <p>Drag and drop your Excel file into the upload area, or click to browse. You can upload multiple files at once. The application will automatically validate your file structure.</p>
                        </div>
                        <div class="tutorial-step">
                            <h3>Step 2: Review Suggested Parameters</h3>
                            <p>After upload, the application suggests optimal column and max characters based on your file analysis. You can adjust these values if needed.</p>
                        </div>
                        <div class="tutorial-step">
                            <h3>Step 3: Process Your File</h3>
                            <p>Click the "Process" button to split long text cells. Processing typically takes 5-10 seconds depending on file size.</p>
                        </div>
                        <div class="tutorial-step">
                            <h3>Step 4: Download Result</h3>
                            <p>Once processing is complete, download your processed file from the "Generated Output" section. You'll also receive an email notification if enabled.</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>Developed by <a href="https://lastchance.ro" target="_blank" rel="noopener noreferrer">LCH team</a></p>
        </footer>

        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Processing file... This may take 5-10 seconds</p>
        </div>

        <div id="notification" class="notification"></div>

        <!-- Preview Modal -->
        <div id="previewModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="previewTitle">File Preview</h3>
                    <button class="modal-close" onclick="closePreview()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="previewInfo" class="preview-info"></div>
                    <div id="previewTable" class="preview-table-container"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let uploadedFiles = [];
        let outputFiles = [];
        let showAllUploaded = false;
        let showAllOutput = false;
        const FILES_PER_PAGE = 3;

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            
            if (diffSec < 60) {
                return 'just now';
            } else if (diffMin < 60) {
                return `${diffMin} minute${diffMin > 1 ? 's' : ''} ago`;
            } else if (diffHour < 24) {
                return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
            } else {
                return date.toLocaleString();
            }
        }

        // Load and display statistics
        async function loadStatistics() {
            try {
                const response = await fetch('/api/statistics');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.statistics;
                    document.getElementById('statTotalProcessed').textContent = stats.total_processed;
                    document.getElementById('statAvgTime').textContent = `${stats.average_processing_time}s`;
                    document.getElementById('statSuccessRate').textContent = `${stats.success_rate}%`;
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Initialize statistics on page load
        loadStatistics();
        // Refresh statistics every 30 seconds
        setInterval(loadStatistics, 30000);

        // Drag and drop functionality
        const uploadDropzone = document.getElementById('uploadDropzone');
        const fileInput = document.getElementById('file');
        const uploadProgressContainer = document.getElementById('uploadProgressContainer');
        const uploadProgressList = document.getElementById('uploadProgressList');

        // Click to browse
        uploadDropzone.addEventListener('click', () => {
            fileInput.click();
        });

        // Drag and drop handlers
        uploadDropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadDropzone.classList.add('drag-over');
        });

        uploadDropzone.addEventListener('dragleave', () => {
            uploadDropzone.classList.remove('drag-over');
        });

        uploadDropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadDropzone.classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files).filter(file => {
                const ext = file.name.split('.').pop().toLowerCase();
                return ext === 'xlsx' || ext === 'xls';
            });
            
            if (files.length > 0) {
                handleFiles(files);
            } else {
                showNotification('Please drop only Excel files (.xlsx or .xls)', 'error');
            }
        });

        // File input change handler
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFiles(Array.from(e.target.files));
            }
        });

        // Handle multiple files
        async function handleFiles(files) {
            uploadProgressContainer.style.display = 'block';
            uploadProgressList.innerHTML = '';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                await uploadFileWithProgress(file, i);
            }
        }

        // Upload file with progress and validation
        async function uploadFileWithProgress(file, index) {
            const progressId = `progress_${index}_${Date.now()}`;
            const progressItem = document.createElement('div');
            progressItem.className = 'upload-progress-item';
            progressItem.id = progressId;
            progressItem.innerHTML = `
                <div class="progress-file-name">${file.name}</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: 0%"></div>
                </div>
                <div class="progress-status">Validating...</div>
            `;
            uploadProgressList.appendChild(progressItem);
            
            const progressBar = progressItem.querySelector('.progress-bar');
            const progressStatus = progressItem.querySelector('.progress-status');
            
            try {
                // Step 1: Advanced validation
                progressBar.style.width = '25%';
                progressStatus.textContent = 'Validating file structure...';
                
                const validationFormData = new FormData();
                validationFormData.append('file', file);
                
                const validationResponse = await fetch('/api/validate-file', {
                    method: 'POST',
                    body: validationFormData
                });
                
                const validationData = await validationResponse.json();
                
                if (!validationData.success || !validationData.valid) {
                    progressBar.style.width = '100%';
                    progressBar.style.backgroundColor = 'var(--error)';
                    progressStatus.textContent = `Validation failed: ${validationData.error}`;
                    progressStatus.style.color = 'var(--error)';
                    return;
                }
                
                // Step 2: Upload file
                progressBar.style.width = '50%';
                progressStatus.textContent = 'Uploading file...';
                
                const uploadFormData = new FormData();
                uploadFormData.append('file', file);
                
                const uploadResponse = await fetch('/upload', {
                    method: 'POST',
                    body: uploadFormData
                });
                
                const uploadData = await uploadResponse.json();
                
                if (!uploadData.success) {
                    progressBar.style.width = '100%';
                    progressBar.style.backgroundColor = 'var(--error)';
                    progressStatus.textContent = `Upload failed: ${uploadData.error}`;
                    progressStatus.style.color = 'var(--error)';
                    return;
                }
                
                // Step 3: Apply suggested parameters
                progressBar.style.width = '75%';
                progressStatus.textContent = 'Applying suggested parameters...';
                
                if (validationData.suggested_parameters) {
                    uploadData.column = validationData.suggested_parameters.column;
                    uploadData.max_chars = validationData.suggested_parameters.max_chars;
                    uploadData.suggested = true;
                }
                
                // Step 4: Complete
                progressBar.style.width = '100%';
                progressBar.style.backgroundColor = 'var(--success)';
                progressStatus.textContent = 'Upload complete!';
                progressStatus.style.color = 'var(--success)';
                
                uploadedFiles.push(uploadData);
                displayUploadedFiles();
                
                // Remove progress item after 2 seconds
                setTimeout(() => {
                    progressItem.remove();
                    if (uploadProgressList.children.length === 0) {
                        uploadProgressContainer.style.display = 'none';
                    }
                }, 2000);
                
                showNotification(`File "${file.name}" uploaded successfully${validationData.suggested_parameters ? ' with suggested parameters' : ''}`, 'success');
                
            } catch (error) {
                progressBar.style.width = '100%';
                progressBar.style.backgroundColor = 'var(--error)';
                progressStatus.textContent = `Error: ${error.message}`;
                progressStatus.style.color = 'var(--error)';
                showNotification(`Error uploading ${file.name}: ${error.message}`, 'error');
            }
        }

        // Old form handler removed - using drag and drop instead

        async function processFile(fileData) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';

            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        uploaded_filename: fileData.uploaded_filename,
                        column: fileData.column,
                        max_chars: fileData.max_chars
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayOutputFile(data.output_filename, data.processing_time);
                    showNotification('File processed successfully!', 'success');
                    // Refresh statistics after successful processing
                    loadStatistics();
                } else {
                    showNotification(data.error || 'Processing failed', 'error');
                    // Refresh statistics even on failure
                    loadStatistics();
                }
            } catch (error) {
                showNotification('Error processing file: ' + error.message, 'error');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        function displayUploadedFiles() {
            const section = document.getElementById('uploadedFilesSection');
            const list = document.getElementById('uploadedFilesList');
            const showMoreBtn = document.getElementById('showMoreUploaded');
            
            section.style.display = 'block';
            list.innerHTML = '';

            // Sort by upload time (newest first)
            const sortedFiles = [...uploadedFiles].sort((a, b) => {
                return new Date(b.upload_time || 0) - new Date(a.upload_time || 0);
            });

            // Show only last 3 files unless showAllUploaded is true
            const filesToShow = showAllUploaded ? sortedFiles : sortedFiles.slice(0, FILES_PER_PAGE);
            
            // Show/hide "Show More" button
            if (sortedFiles.length > FILES_PER_PAGE) {
                showMoreBtn.style.display = 'block';
                showMoreBtn.textContent = showAllUploaded ? 'Show Less' : 'Show More';
            } else {
                showMoreBtn.style.display = 'none';
            }

            filesToShow.forEach((file) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                const uploadTime = file.upload_time ? formatTime(file.upload_time) : 'Unknown';
                // Create a closure-safe reference to the file data
                const fileData = file;
                // Use stored values or defaults
                const defaultColumn = file.column || '';
                const defaultMaxChars = file.max_chars || '';
                const suggestedBadge = file.suggested ? '<span class="suggested-badge" title="Parameters suggested by automatic analysis">‚ú® Suggested</span>' : '';
                fileItem.innerHTML = `
                    <div class="file-item-top">
                        <div class="file-info">
                            <a href="/download/uploads/${file.uploaded_filename}" class="file-link" download>${file.filename}</a>
                            <span class="file-meta">Uploaded: ${uploadTime} ${suggestedBadge}</span>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-preview" onclick="previewFile('uploads', '${file.uploaded_filename}')" title="Preview file contents">Preview</button>
                            <button class="btn btn-process" title="Process file with current parameters">Process</button>
                        </div>
                    </div>
                    <div class="file-params">
                        <div class="param-group">
                            <label for="column_${file.file_id}" title="Column letter containing the data to process (e.g., A, B, C)">Column:</label>
                            <input type="text" id="column_${file.file_id}" class="param-input" 
                                   placeholder="A, B, C..." pattern="[A-Za-z]+" maxlength="3" 
                                   value="${defaultColumn}" style="text-transform: uppercase;">
                        </div>
                        <div class="param-group">
                            <label for="max_chars_${file.file_id}">
                                Max Chars:
                                <span class="help-icon" title="Recommended: 18-20 characters. Maximum: 23 characters. The application suggests 20 by default.">‚ÑπÔ∏è</span>
                            </label>
                            <input type="number" id="max_chars_${file.file_id}" class="param-input" 
                                   placeholder="20" min="18" max="23" value="${defaultMaxChars}">
                            <small class="param-hint">Recommended: 18-20 (suggested: 20)</small>
                        </div>
                    </div>
                `;
                // Attach event listener properly
                const processBtn = fileItem.querySelector('.btn-process');
                processBtn.addEventListener('click', () => {
                    const columnInput = fileItem.querySelector(`#column_${file.file_id}`);
                    const maxCharsInput = fileItem.querySelector(`#max_chars_${file.file_id}`);
                    const column = columnInput.value.trim().toUpperCase();
                    const maxChars = maxCharsInput.value.trim();
                    
                    // Validate inputs
                    if (!column) {
                        showNotification('Please enter a column name', 'error');
                        columnInput.focus();
                        return;
                    }
                    if (!/^[A-Z]+$/.test(column)) {
                        showNotification('Column must contain only uppercase letters (A-Z)', 'error');
                        columnInput.focus();
                        return;
                    }
                    if (!maxChars || parseInt(maxChars) < 18) {
                        showNotification('Max characters must be at least 18 (recommended: 18-20)', 'error');
                        maxCharsInput.focus();
                        return;
                    }
                    if (parseInt(maxChars) > 23) {
                        showNotification('Max characters cannot exceed 23 (recommended: 18-20)', 'error');
                        maxCharsInput.focus();
                        return;
                    }
                    
                    // Update file data with current values
                    fileData.column = column;
                    fileData.max_chars = parseInt(maxChars);
                    processFile(fileData);
                });
                list.appendChild(fileItem);
            });
        }

        function toggleUploadedFiles() {
            showAllUploaded = !showAllUploaded;
            displayUploadedFiles();
        }

        function displayOutputFile(filename, processingTime) {
            const section = document.getElementById('outputFilesSection');
            const list = document.getElementById('outputFilesList');
            const showMoreBtn = document.getElementById('showMoreOutput');
            
            section.style.display = 'block';
            
            // Add to output files array with timestamp
            const outputFile = {
                filename: filename,
                processing_time: processingTime,
                created_time: new Date().toISOString()
            };
            outputFiles.unshift(outputFile); // Add to beginning (newest first)
            
            // Show only last 3 files unless showAllOutput is true
            const filesToShow = showAllOutput ? outputFiles : outputFiles.slice(0, FILES_PER_PAGE);
            
            // Show/hide "Show More" button
            if (outputFiles.length > FILES_PER_PAGE) {
                showMoreBtn.style.display = 'block';
                showMoreBtn.textContent = showAllOutput ? 'Show Less' : 'Show More';
            } else {
                showMoreBtn.style.display = 'none';
            }
            
            list.innerHTML = '';
            filesToShow.forEach((file) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item output-item';
                const createdTime = file.created_time ? formatTime(file.created_time) : 'Unknown';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <a href="/download/outputs/${file.filename}" class="file-link" download>${file.filename}</a>
                        <span class="file-meta">Ready for download | Processing time: ${file.processing_time} sec | Created: ${createdTime}</span>
                    </div>
                `;
                list.appendChild(fileItem);
            });
        }

        function toggleOutputFiles() {
            showAllOutput = !showAllOutput;
            const list = document.getElementById('outputFilesList');
            const showMoreBtn = document.getElementById('showMoreOutput');
            
            const filesToShow = showAllOutput ? outputFiles : outputFiles.slice(0, FILES_PER_PAGE);
            
            if (outputFiles.length > FILES_PER_PAGE) {
                showMoreBtn.style.display = 'block';
                showMoreBtn.textContent = showAllOutput ? 'Show Less' : 'Show More';
            } else {
                showMoreBtn.style.display = 'none';
            }
            
            list.innerHTML = '';
            filesToShow.forEach((file) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item output-item';
                const createdTime = file.created_time ? formatTime(file.created_time) : 'Unknown';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <a href="/download/outputs/${file.filename}" class="file-link" download>${file.filename}</a>
                        <span class="file-meta">Ready for download | Processing time: ${file.processing_time} sec | Created: ${createdTime}</span>
                    </div>
                    <div class="file-actions">
                        <button class="btn btn-preview" onclick="previewFile('outputs', '${file.filename}')">Preview</button>
                    </div>
                `;
                list.appendChild(fileItem);
            });
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            notification.classList.remove('fade-out');

            // 5 seconds for all notifications
            const timeout = 5000;
            
            // Start fade-out animation 500ms before hiding
            setTimeout(() => {
                notification.classList.add('fade-out');
            }, timeout - 500);
            
            setTimeout(() => {
                notification.style.display = 'none';
                notification.classList.remove('fade-out');
            }, timeout);
        }

        async function previewFile(folder, filename) {
            const modal = document.getElementById('previewModal');
            const title = document.getElementById('previewTitle');
            const info = document.getElementById('previewInfo');
            const table = document.getElementById('previewTable');
            
            // Show modal with loading state
            modal.style.display = 'flex';
            title.textContent = 'Loading preview...';
            info.innerHTML = '';
            table.innerHTML = '<div class="loading">Loading file preview...</div>';
            
            try {
                const response = await fetch(`/preview/${folder}/${filename}`);
                const data = await response.json();
                
                if (data.success) {
                    title.textContent = `Preview: ${data.filename}`;
                    info.innerHTML = `
                        <div class="preview-meta">
                            <span><strong>Sheet:</strong> ${data.sheet_name}</span>
                            <span><strong>Total Rows:</strong> ${data.total_rows}</span>
                            <span><strong>Total Columns:</strong> ${data.total_columns}</span>
                            <span><strong>Preview:</strong> First ${data.preview_rows} rows, ${data.preview_columns} columns</span>
                        </div>
                    `;
                    
                    // Create preview table
                    if (data.data && data.data.length > 0) {
                        let tableHTML = '<table class="preview-table"><thead><tr>';
                        // Header row
                        for (let i = 0; i < data.preview_columns; i++) {
                            tableHTML += `<th>${String.fromCharCode(65 + i)}</th>`;
                        }
                        tableHTML += '</tr></thead><tbody>';
                        
                        // Data rows
                        data.data.forEach((row, rowIdx) => {
                            tableHTML += '<tr>';
                            for (let i = 0; i < data.preview_columns; i++) {
                                const cellValue = row[i] || '';
                                tableHTML += `<td title="${cellValue}">${cellValue}</td>`;
                            }
                            tableHTML += '</tr>';
                        });
                        
                        tableHTML += '</tbody></table>';
                        table.innerHTML = tableHTML;
                    } else {
                        table.innerHTML = '<div class="preview-empty">No data to preview</div>';
                    }
                } else {
                    title.textContent = 'Preview Error';
                    info.innerHTML = '';
                    table.innerHTML = `<div class="preview-error">${data.error || 'Failed to load preview'}</div>`;
                }
            } catch (error) {
                title.textContent = 'Preview Error';
                info.innerHTML = '';
                table.innerHTML = `<div class="preview-error">Error loading preview: ${error.message}</div>`;
            }
        }

        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('previewModal');
            if (event.target === modal) {
                closePreview();
            }
        }

        // Help section functions
        function toggleHelp() {
            const helpContent = document.getElementById('helpContent');
            const toggleBtn = document.querySelector('.btn-help-toggle');
            if (helpContent.style.display === 'none') {
                helpContent.style.display = 'block';
                toggleBtn.textContent = '‚àí';
            } else {
                helpContent.style.display = 'none';
                toggleBtn.textContent = '+';
            }
        }

        function showHelpTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.help-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.help-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`help${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
            event.target.classList.add('active');
        }

        function toggleFaq(element) {
            const faqItem = element.closest('.faq-item');
            const toggle = element.querySelector('.faq-toggle');
            
            // Check if this FAQ is already active
            const isActive = faqItem.classList.contains('active');
            
            // Close all FAQs first
            document.querySelectorAll('.faq-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.faq-toggle').forEach(tog => {
                tog.textContent = '+';
            });
            
            // If this FAQ wasn't active, open it
            if (!isActive) {
                faqItem.classList.add('active');
                toggle.textContent = '‚àí';
            }
        }
    </script>
</body>
</html>

