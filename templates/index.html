<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integral ProjectText FileProcessor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logos-container">
                    <div class="icon-wrapper">
                        <img src="{{ url_for('static', filename='images/icon.png') }}" 
                             onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/icon.svg') }}';" 
                             alt="Icon" class="logo-icon">
                    </div>
                    <div class="logo-container">
                        <img src="{{ url_for('static', filename='images/logo.png') }}" 
                             onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/logo.svg') }}';" 
                             alt="SCHRACK SECONET Logo" class="logo-main">
                    </div>
                </div>
                <div class="header-text">
                    <h1>Integral ProjectText FileProcessor</h1>
                    <p class="subtitle">ProceseazƒÉ numele entitatilor din Project Text pentru incadrare optima</p>
                </div>
            </div>
            {% if user %}
            <div class="user-menu">
                <div class="user-info">
                    <img src="{{ user.picture if user.picture else url_for('static', filename='images/default-avatar.svg') }}" 
                         alt="User Avatar" 
                         class="user-avatar"
                         onerror="this.onerror=null; this.src='{{ url_for('static', filename='images/default-avatar.svg') }}';">
                    <span class="user-name">{{ user.name }}</span>
                </div>
                <a href="{{ url_for('logout') }}" class="btn btn-logout">Deconectare</a>
            </div>
            {% endif %}
        </header>

        <main>
            <!-- Statistics Dashboard -->
            <section class="statistics-section" id="statisticsSection">
                <h2>Statistici Procesare</h2>
                <div class="stats-grid" id="statsGrid">
                    <div class="stat-card">
                        <div class="stat-value" id="statTotalProcessed">0</div>
                        <div class="stat-label">Fi»ôiere Procesate Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statAvgTime">0.0s</div>
                        <div class="stat-label">Timp Mediu de Procesare</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statSuccessRate">0%</div>
                        <div class="stat-label">RatƒÉ de Succes</div>
                    </div>
                </div>
            </section>

            <section class="upload-section">
                <h2>√éncƒÉrcare Fi»ôier</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-dropzone" id="uploadDropzone">
                        <div class="upload-icon">üìÅ</div>
                        <p class="upload-text">Trage»õi »ôi plasa»õi fi»ôierele Excel aici</p>
                        <p class="upload-subtext">sau face»õi clic pentru a naviga</p>
                        <input type="file" id="file" name="file" accept=".xlsx,.xls" multiple style="display: none;">
                    </div>
                    <div id="uploadProgressContainer" style="display: none;">
                        <div class="upload-progress-list" id="uploadProgressList"></div>
                    </div>
                </div>
                <form id="uploadForm" enctype="multipart/form-data" style="display: none;">
                </form>
                <p class="form-hint">DupƒÉ √ÆncƒÉrcare, seta»õi coloana »ôi numƒÉrul maxim de caractere pentru fiecare fi»ôier √Ænainte de procesare.</p>
            </section>

            <section class="files-section" id="uploadedFilesSection" style="display: none;">
                <h2>Fi»ôiere √éncƒÉrcate</h2>
                <div id="uploadedFilesList"></div>
                <button id="showMoreUploaded" class="btn btn-show-more" style="display: none;" onclick="toggleUploadedFiles()">Afi»ôeazƒÉ Mai Multe</button>
            </section>

            <section class="files-section" id="outputFilesSection" style="display: none;">
                <h2>Rezultate Generate</h2>
                <div id="outputFilesList"></div>
                <button id="showMoreOutput" class="btn btn-show-more" style="display: none;" onclick="toggleOutputFiles()">Afi»ôeazƒÉ Mai Multe</button>
            </section>

            <!-- Help Section -->
            <section class="help-section" id="helpSection">
                <h2>
                    Ajutor & √éntrebƒÉri Frecvente
                    <button class="btn-help-toggle" onclick="toggleHelp()">‚àí</button>
                </h2>
                <div class="help-content" id="helpContent">
                    <div class="help-tabs">
                        <button class="help-tab active" onclick="showHelpTab('faq')">√éntrebƒÉri Frecvente</button>
                        <button class="help-tab" onclick="showHelpTab('tutorial')">Tutorial</button>
                    </div>
                    
                    <div class="help-tab-content active" id="helpFaq">
                        <div class="faq-item">
                            <h3 class="faq-question" onclick="toggleFaq(this)">Ce formate de fi»ôiere sunt suportate? <span class="faq-toggle">+</span></h3>
                            <div class="faq-answer">Aplica»õia suportƒÉ fi»ôiere Excel √Æn formatele .xlsx »ôi .xls. Fi»ôierele trebuie sƒÉ con»õinƒÉ exact o foaie de calcul cu date √Æntr-o singurƒÉ coloanƒÉ.</div>
                        </div>
                        <div class="faq-item">
                            <h3 class="faq-question" onclick="toggleFaq(this)">Care sunt cerin»õele pentru fi»ôiere? <span class="faq-toggle">+</span></h3>
                            <div class="faq-answer">Fi»ôierul dvs. Excel trebuie sƒÉ aibƒÉ: (1) Exact o foaie de calcul, (2) Date √Æntr-o singurƒÉ coloanƒÉ, (3) Dimensiune maximƒÉ de 16MB. Aplica»õia va valida automat fi»ôierul dvs. √Ænainte de procesare.</div>
                        </div>
                        <div class="faq-item">
                            <h3 class="faq-question" onclick="toggleFaq(this)">Cum func»õioneazƒÉ divizarea textului? <span class="faq-toggle">+</span></h3>
                            <div class="faq-answer">Aplica»õia √Æmparte celulele cu text lung la ultimul spa»õiu √Ænainte de limita maximƒÉ de caractere. Textul rƒÉmas este mutat √Æn coloana urmƒÉtoare. Acest proces continuƒÉ p√¢nƒÉ c√¢nd toate celulele sunt √Æn limita specificatƒÉ.</div>
                        </div>
                        <div class="faq-item">
                            <h3 class="faq-question" onclick="toggleFaq(this)">Ce se √Ænt√¢mplƒÉ dacƒÉ introduc parametri gre»ôi»õi? <span class="faq-toggle">+</span></h3>
                            <div class="faq-answer">Nicio problemƒÉ! Pute»õi ajusta coloana »ôi numƒÉrul maxim de caractere pentru orice fi»ôier √ÆncƒÉrcat fƒÉrƒÉ sƒÉ-l re√ÆncƒÉrca»õi. Doar schimba»õi valorile »ôi face»õi clic pe ProceseazƒÉ din nou.</div>
                        </div>
                        <div class="faq-item">
                            <h3 class="faq-question" onclick="toggleFaq(this)">Cum »ôtiu ce coloanƒÉ sƒÉ folosesc? <span class="faq-toggle">+</span></h3>
                            <div class="faq-answer">C√¢nd √ÆncƒÉrca»õi un fi»ôier, aplica»õia detecteazƒÉ automat ce coloanƒÉ con»õine date »ôi o sugereazƒÉ. De asemenea, pute»õi folosi butonul Preview pentru a vedea structura fi»ôierului √Ænainte de procesare.</div>
                        </div>
                        <div class="faq-item">
                            <h3 class="faq-question" onclick="toggleFaq(this)">Care este limita maximƒÉ de caractere? <span class="faq-toggle">+</span></h3>
                            <div class="faq-answer">NumƒÉrul maxim de caractere per celulƒÉ ar trebui sƒÉ fie ideal √Æntre 18 »ôi 20 de caractere, »ôi nu trebuie sƒÉ depƒÉ»ôeascƒÉ 23 de caractere. Aplica»õia va sugera automat 20 de caractere c√¢nd √ÆncƒÉrca»õi un fi»ôier, care este valoarea optimƒÉ pentru majoritatea cazurilor de utilizare.</div>
                        </div>
                    </div>
                    
                    <div class="help-tab-content" id="helpTutorial">
                        <div class="tutorial-step">
                            <h3>Pasul 1: √éncƒÉrca»õi Fi»ôierul</h3>
                            <p>Trage»õi »ôi plasa»õi fi»ôierul Excel √Æn zona de √ÆncƒÉrcare, sau face»õi clic pentru a naviga. Pute»õi √ÆncƒÉrca mai multe fi»ôiere simultan. Aplica»õia va valida automat structura fi»ôierului dvs.</p>
                        </div>
                        <div class="tutorial-step">
                            <h3>Pasul 2: Examina»õi Parametrii Sugera»õi</h3>
                            <p>DupƒÉ √ÆncƒÉrcare, aplica»õia sugereazƒÉ coloana optimƒÉ »ôi numƒÉrul maxim de caractere pe baza analizei fi»ôierului. Pute»õi ajusta aceste valori dacƒÉ este necesar.</p>
                        </div>
                        <div class="tutorial-step">
                            <h3>Pasul 3: Procesa»õi Fi»ôierul</h3>
                            <p>Face»õi clic pe butonul "ProceseazƒÉ" pentru a √ÆmpƒÉr»õi celulele cu text lung. Procesarea dureazƒÉ de obicei 5-10 secunde √Æn func»õie de dimensiunea fi»ôierului.</p>
                        </div>
                        <div class="tutorial-step">
                            <h3>Pasul 4: DescƒÉrca»õi Rezultatul</h3>
                            <p>OdatƒÉ ce procesarea este completƒÉ, descƒÉrca»õi fi»ôierul procesat din sec»õiunea "Rezultate Generate". Ve»õi primi »ôi o notificare prin email dacƒÉ este activatƒÉ.</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <footer>
            <p>Dezvoltat de <a href="https://lastchance.ro" target="_blank" rel="noopener noreferrer">Echipa LCH</a></p>
        </footer>

        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
            <p>Se proceseazƒÉ fi»ôierul... Acest proces poate dura 5-10 secunde</p>
        </div>

        <div id="notification" class="notification"></div>

        <!-- Preview Modal -->
        <div id="previewModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="previewTitle">Previzualizare Fi»ôier</h3>
                    <button class="modal-close" onclick="closePreview()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="previewInfo" class="preview-info"></div>
                    <div id="previewSearchContainer" style="display: none; margin-bottom: 15px;">
                        <input type="text" id="previewSearchInput" class="preview-search-input" 
                               placeholder="CƒÉutare √Æn date..." 
                               style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem;">
                    </div>
                    <div id="previewTable"></div>
                    <div id="previewPagination" class="preview-pagination" style="display: none; margin-top: 20px;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let uploadedFiles = [];
        let outputFiles = [];
        let showAllUploaded = false;
        let showAllOutput = false;
        const FILES_PER_PAGE = 3;

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            
            if (diffSec < 60) {
                return 'just now';
            } else if (diffMin < 60) {
                return `${diffMin} minute${diffMin > 1 ? 's' : ''} ago`;
            } else if (diffHour < 24) {
                return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
            } else {
                return date.toLocaleString();
            }
        }

        // Load and display statistics
        async function loadStatistics() {
            try {
                const response = await fetch('/api/statistics');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.statistics;
                    document.getElementById('statTotalProcessed').textContent = stats.total_processed;
                    document.getElementById('statAvgTime').textContent = `${stats.average_processing_time}s`;
                    document.getElementById('statSuccessRate').textContent = `${stats.success_rate}%`;
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Initialize statistics on page load
        loadStatistics();
        // Refresh statistics every 30 seconds
        setInterval(loadStatistics, 30000);

        // Drag and drop functionality
        const uploadDropzone = document.getElementById('uploadDropzone');
        const fileInput = document.getElementById('file');
        const uploadProgressContainer = document.getElementById('uploadProgressContainer');
        const uploadProgressList = document.getElementById('uploadProgressList');

        // Click to browse
        uploadDropzone.addEventListener('click', () => {
            fileInput.click();
        });

        // Drag and drop handlers
        uploadDropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadDropzone.classList.add('drag-over');
        });

        uploadDropzone.addEventListener('dragleave', () => {
            uploadDropzone.classList.remove('drag-over');
        });

        uploadDropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadDropzone.classList.remove('drag-over');
            
            const files = Array.from(e.dataTransfer.files).filter(file => {
                const ext = file.name.split('.').pop().toLowerCase();
                return ext === 'xlsx' || ext === 'xls';
            });
            
            if (files.length > 0) {
                handleFiles(files);
            } else {
                showNotification('VƒÉ rugƒÉm sƒÉ plasa»õi doar fi»ôiere Excel (.xlsx sau .xls)', 'error');
            }
        });

        // File input change handler
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFiles(Array.from(e.target.files));
            }
        });

        // Handle multiple files
        async function handleFiles(files) {
            uploadProgressContainer.style.display = 'block';
            uploadProgressList.innerHTML = '';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                await uploadFileWithProgress(file, i);
            }
        }

        // Upload file with progress and validation
        async function uploadFileWithProgress(file, index) {
            const progressId = `progress_${index}_${Date.now()}`;
            const progressItem = document.createElement('div');
            progressItem.className = 'upload-progress-item';
            progressItem.id = progressId;
            progressItem.innerHTML = `
                <div class="progress-file-name">${file.name}</div>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: 0%"></div>
                </div>
                <div class="progress-status">Validating...</div>
            `;
            uploadProgressList.appendChild(progressItem);
            
            const progressBar = progressItem.querySelector('.progress-bar');
            const progressStatus = progressItem.querySelector('.progress-status');
            
            try {
                // Step 1: Advanced validation
                progressBar.style.width = '25%';
                progressStatus.textContent = 'Se valideazƒÉ structura fi»ôierului...';
                
                const validationFormData = new FormData();
                validationFormData.append('file', file);
                
                const validationResponse = await fetch('/api/validate-file', {
                    method: 'POST',
                    body: validationFormData
                });
                
                const validationData = await validationResponse.json();
                
                if (!validationData.success || !validationData.valid) {
                    progressBar.style.width = '100%';
                    progressBar.style.backgroundColor = 'var(--error)';
                    progressStatus.textContent = `Validare e»ôuatƒÉ: ${validationData.error}`;
                    progressStatus.style.color = 'var(--error)';
                    return;
                }
                
                // Step 2: Upload file
                progressBar.style.width = '50%';
                progressStatus.textContent = 'Se √ÆncarcƒÉ fi»ôierul...';
                
                const uploadFormData = new FormData();
                uploadFormData.append('file', file);
                
                const uploadResponse = await fetch('/upload', {
                    method: 'POST',
                    body: uploadFormData
                });
                
                const uploadData = await uploadResponse.json();
                
                if (!uploadData.success) {
                    progressBar.style.width = '100%';
                    progressBar.style.backgroundColor = 'var(--error)';
                    progressStatus.textContent = `√éncƒÉrcare e»ôuatƒÉ: ${uploadData.error}`;
                    progressStatus.style.color = 'var(--error)';
                    return;
                }
                
                // Step 3: Apply suggested parameters
                progressBar.style.width = '75%';
                progressStatus.textContent = 'Se aplicƒÉ parametrii sugera»õi...';
                
                if (validationData.suggested_parameters) {
                    uploadData.column = validationData.suggested_parameters.column;
                    uploadData.max_chars = validationData.suggested_parameters.max_chars;
                    uploadData.suggested = true;
                }
                
                // Step 4: Complete
                progressBar.style.width = '100%';
                progressBar.style.backgroundColor = 'var(--success)';
                progressStatus.textContent = '√éncƒÉrcare completƒÉ!';
                progressStatus.style.color = 'var(--success)';
                
                uploadedFiles.push(uploadData);
                displayUploadedFiles();
                
                // Remove progress item after 2 seconds
                setTimeout(() => {
                    progressItem.remove();
                    if (uploadProgressList.children.length === 0) {
                        uploadProgressContainer.style.display = 'none';
                    }
                }, 2000);
                
                showNotification(`Fi»ôierul "${file.name}" a fost √ÆncƒÉrcat cu succes${validationData.suggested_parameters ? ' cu parametrii sugera»õi' : ''}`, 'success');
                
            } catch (error) {
                progressBar.style.width = '100%';
                progressBar.style.backgroundColor = 'var(--error)';
                progressStatus.textContent = `Error: ${error.message}`;
                progressStatus.style.color = 'var(--error)';
                showNotification(`Eroare la √ÆncƒÉrcarea ${file.name}: ${error.message}`, 'error');
            }
        }

        // Old form handler removed - using drag and drop instead

        async function processFile(fileData) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.style.display = 'flex';

            try {
                const response = await fetch('/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        uploaded_filename: fileData.uploaded_filename,
                        column: fileData.column,
                        max_chars: fileData.max_chars
                    })
                });

                const data = await response.json();

                if (data.success) {
                    displayOutputFile(data.output_filename, data.processing_time);
                    showNotification('File processed successfully!', 'success');
                    // Refresh statistics after successful processing
                    loadStatistics();
                } else {
                    showNotification(data.error || 'Processing failed', 'error');
                    // Refresh statistics even on failure
                    loadStatistics();
                }
            } catch (error) {
                showNotification('Error processing file: ' + error.message, 'error');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        function displayUploadedFiles() {
            const section = document.getElementById('uploadedFilesSection');
            const list = document.getElementById('uploadedFilesList');
            const showMoreBtn = document.getElementById('showMoreUploaded');
            
            section.style.display = 'block';
            list.innerHTML = '';

            // Sort by upload time (newest first)
            const sortedFiles = [...uploadedFiles].sort((a, b) => {
                return new Date(b.upload_time || 0) - new Date(a.upload_time || 0);
            });

            // Show only last 3 files unless showAllUploaded is true
            const filesToShow = showAllUploaded ? sortedFiles : sortedFiles.slice(0, FILES_PER_PAGE);
            
            // Show/hide "Show More" button
            if (sortedFiles.length > FILES_PER_PAGE) {
                showMoreBtn.style.display = 'block';
                showMoreBtn.textContent = showAllUploaded ? 'Afi»ôeazƒÉ Mai Pu»õine' : 'Afi»ôeazƒÉ Mai Multe';
            } else {
                showMoreBtn.style.display = 'none';
            }

            filesToShow.forEach((file) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                const uploadTime = file.upload_time ? formatTime(file.upload_time) : 'Unknown';
                // Create a closure-safe reference to the file data
                const fileData = file;
                // Use stored values or defaults
                const defaultColumn = file.column || '';
                // Always default to 20 if not provided or if value is invalid
                let defaultMaxChars = file.max_chars;
                if (!defaultMaxChars || defaultMaxChars === '' || defaultMaxChars < 18 || defaultMaxChars > 23) {
                    defaultMaxChars = '20';
                }
                const suggestedBadge = file.suggested ? '<span class="suggested-badge" title="Parameters suggested by automatic analysis">‚ú® Suggested</span>' : '';
                fileItem.innerHTML = `
                    <div class="file-item-top">
                        <div class="file-info">
                            <a href="/download/uploads/${file.uploaded_filename}" class="file-link" download>${file.filename}</a>
                            <span class="file-meta">√éncƒÉrcat: ${uploadTime} ${suggestedBadge}</span>
                        </div>
                        <div class="file-actions">
                            <button class="btn btn-preview" onclick="previewFile('uploads', '${file.uploaded_filename}')" title="Previzualizare con»õinut fi»ôier">Previzualizare</button>
                            <button class="btn btn-process" title="ProceseazƒÉ fi»ôierul cu parametrii actuali">ProceseazƒÉ</button>
                        </div>
                    </div>
                    <div class="file-params">
                        <div class="param-group">
                            <label for="column_${file.file_id}" title="Litera coloanei care con»õine datele de procesat (ex: A, B, C)">ColoanƒÉ:</label>
                            <input type="text" id="column_${file.file_id}" class="param-input" 
                                   placeholder="A, B, C..." pattern="[A-Za-z]+" maxlength="3" 
                                   value="${defaultColumn}" style="text-transform: uppercase;">
                        </div>
                        <div class="param-group">
                            <label for="max_chars_${file.file_id}">
                                Max Caractere:
                                <span class="help-icon" title="Recomandat: 18-20 caractere. Maxim: 23 caractere. Aplica»õia sugereazƒÉ 20 implicit.">‚ÑπÔ∏è</span>
                            </label>
                            <input type="number" id="max_chars_${file.file_id}" class="param-input" 
                                   placeholder="20" min="18" max="23" value="${defaultMaxChars}">
                            <small class="param-hint">Recomandat: 18-20 (sugerat: 20)</small>
                        </div>
                    </div>
                `;
                // Attach event listener properly
                const processBtn = fileItem.querySelector('.btn-process');
                processBtn.addEventListener('click', () => {
                    const columnInput = fileItem.querySelector(`#column_${file.file_id}`);
                    const maxCharsInput = fileItem.querySelector(`#max_chars_${file.file_id}`);
                    const column = columnInput.value.trim().toUpperCase();
                    const maxChars = maxCharsInput.value.trim();
                    
                    // Validate inputs
                    if (!column) {
                        showNotification('VƒÉ rugƒÉm sƒÉ introduce»õi o coloanƒÉ', 'error');
                        columnInput.focus();
                        return;
                    }
                    if (!/^[A-Z]+$/.test(column)) {
                        showNotification('Coloana trebuie sƒÉ con»õinƒÉ doar litere mari (A-Z)', 'error');
                        columnInput.focus();
                        return;
                    }
                    if (!maxChars || parseInt(maxChars) < 18) {
                        showNotification('NumƒÉrul maxim de caractere trebuie sƒÉ fie cel pu»õin 18 (recomandat: 18-20)', 'error');
                        maxCharsInput.focus();
                        return;
                    }
                    if (parseInt(maxChars) > 23) {
                        showNotification('NumƒÉrul maxim de caractere nu poate depƒÉ»ôi 23 (recomandat: 18-20)', 'error');
                        maxCharsInput.focus();
                        return;
                    }
                    
                    // Update file data with current values
                    fileData.column = column;
                    fileData.max_chars = parseInt(maxChars);
                    processFile(fileData);
                });
                list.appendChild(fileItem);
            });
        }

        function toggleUploadedFiles() {
            showAllUploaded = !showAllUploaded;
            displayUploadedFiles();
        }

        function displayOutputFile(filename, processingTime) {
            const section = document.getElementById('outputFilesSection');
            const list = document.getElementById('outputFilesList');
            const showMoreBtn = document.getElementById('showMoreOutput');
            
            section.style.display = 'block';
            
            // Add to output files array with timestamp
            const outputFile = {
                filename: filename,
                processing_time: processingTime,
                created_time: new Date().toISOString()
            };
            outputFiles.unshift(outputFile); // Add to beginning (newest first)
            
            // Show only last 3 files unless showAllOutput is true
            const filesToShow = showAllOutput ? outputFiles : outputFiles.slice(0, FILES_PER_PAGE);
            
            // Show/hide "Show More" button
            if (outputFiles.length > FILES_PER_PAGE) {
                showMoreBtn.style.display = 'block';
                showMoreBtn.textContent = showAllOutput ? 'Show Less' : 'Show More';
            } else {
                showMoreBtn.style.display = 'none';
            }
            
            list.innerHTML = '';
            filesToShow.forEach((file) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item output-item';
                const createdTime = file.created_time ? formatTime(file.created_time) : 'Unknown';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <a href="/download/outputs/${file.filename}" class="file-link" download>${file.filename}</a>
                        <span class="file-meta">Gata pentru descƒÉrcare | Timp procesare: ${file.processing_time} sec | Creat: ${createdTime}</span>
                    </div>
                    <div class="file-actions">
                        <button class="btn btn-preview" onclick="previewFile('outputs', '${file.filename}')">Previzualizare</button>
                    </div>
                `;
                list.appendChild(fileItem);
            });
        }

        function toggleOutputFiles() {
            showAllOutput = !showAllOutput;
            const list = document.getElementById('outputFilesList');
            const showMoreBtn = document.getElementById('showMoreOutput');
            
            const filesToShow = showAllOutput ? outputFiles : outputFiles.slice(0, FILES_PER_PAGE);
            
            if (outputFiles.length > FILES_PER_PAGE) {
                showMoreBtn.style.display = 'block';
                showMoreBtn.textContent = showAllOutput ? 'Show Less' : 'Show More';
            } else {
                showMoreBtn.style.display = 'none';
            }
            
            list.innerHTML = '';
            filesToShow.forEach((file) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item output-item';
                const createdTime = file.created_time ? formatTime(file.created_time) : 'Unknown';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <a href="/download/outputs/${file.filename}" class="file-link" download>${file.filename}</a>
                        <span class="file-meta">Ready for download | Processing time: ${file.processing_time} sec | Created: ${createdTime}</span>
                    </div>
                    <div class="file-actions">
                            <button class="btn btn-preview" onclick="previewFile('outputs', '${file.filename}')">Previzualizare</button>
                    </div>
                `;
                list.appendChild(fileItem);
            });
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            notification.classList.remove('fade-out');

            // 5 seconds for all notifications
            const timeout = 5000;
            
            // Start fade-out animation 500ms before hiding
            setTimeout(() => {
                notification.classList.add('fade-out');
            }, timeout - 500);
            
            setTimeout(() => {
                notification.style.display = 'none';
                notification.classList.remove('fade-out');
            }, timeout);
        }

        // Store preview data for search functionality
        let previewDataStore = {
            allData: [],
            filteredData: [],
            currentPage: 1,
            totalPages: 1,
            rowsPerPage: 50,
            totalRows: 0,
            previewColumns: 0,
            totalColumns: 0,
            sheetName: '',
            filename: '',
            folder: '',
            isInputFile: false
        };

        // Helper function to convert column index to letter
        function getColumnLetter(index) {
            let result = '';
            index++; // Convert to 1-based
            while (index > 0) {
                index--;
                result = String.fromCharCode(65 + (index % 26)) + result;
                index = Math.floor(index / 26);
            }
            return result;
        }

        // Render preview table
        function renderPreviewTable(data, startRow = 1) {
            const table = document.getElementById('previewTable');
            if (!data || data.length === 0) {
                table.innerHTML = '<div class="preview-empty">Nu existƒÉ date de previzualizat</div>';
                return;
            }

            let tableHTML = '<div class="preview-table-container"><table class="preview-table"><thead><tr>';
            // Header row
            for (let i = 0; i < previewDataStore.previewColumns; i++) {
                tableHTML += `<th>${getColumnLetter(i)}</th>`;
            }
            tableHTML += '</tr></thead><tbody>';
            
            // Data rows
            data.forEach((row, rowIdx) => {
                const actualRowNum = startRow + rowIdx;
                tableHTML += `<tr data-row="${actualRowNum}">`;
                for (let i = 0; i < previewDataStore.previewColumns; i++) {
                    const cellValue = row[i] || '';
                    tableHTML += `<td title="${cellValue}">${cellValue}</td>`;
                }
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table></div>';
            table.innerHTML = tableHTML;
        }

        // Render pagination controls
        function renderPagination() {
            const pagination = document.getElementById('previewPagination');
            if (!pagination) {
                console.error('Pagination element not found');
                return;
            }
            
            // Multiple checks to hide pagination for output files
            if (previewDataStore.isOutputFile || 
                pagination.getAttribute('data-output-file') === 'true' ||
                previewDataStore.folder === 'outputs') {
                pagination.style.display = 'none';
                pagination.innerHTML = '';
                pagination.setAttribute('data-output-file', 'true');
                console.log('Pagination hidden for output file');
                return;
            }
            
            // Always show pagination if there are more than 50 rows, even if totalPages is 1
            if (previewDataStore.totalPages <= 1 && previewDataStore.totalRows <= 50) {
                pagination.style.display = 'none';
                return;
            }

            // Double check - never show pagination for output files
            if (previewDataStore.isOutputFile || 
                pagination.getAttribute('data-output-file') === 'true' ||
                previewDataStore.folder === 'outputs') {
                console.log('renderPagination: BLOCKED - isOutputFile detected');
                pagination.style.display = 'none';
                pagination.style.visibility = 'hidden';
                pagination.innerHTML = '';
                pagination.setAttribute('data-output-file', 'true');
                return;
            }
            
            console.log('renderPagination: ALLOWED - showing pagination');
            pagination.style.display = 'flex';
            pagination.style.visibility = 'visible';
            let paginationHTML = '';
            
            // Previous button
            paginationHTML += `<button class="btn-pagination" onclick="changePreviewPage(${previewDataStore.currentPage - 1})" 
                ${previewDataStore.currentPage === 1 ? 'disabled' : ''}>‚Äπ Anterior</button>`;
            
            // Page numbers
            const maxPagesToShow = 7;
            let startPage = Math.max(1, previewDataStore.currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(previewDataStore.totalPages, startPage + maxPagesToShow - 1);
            
            if (startPage > 1) {
                paginationHTML += `<button class="btn-pagination" onclick="changePreviewPage(1)">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span>...</span>`;
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `<button class="btn-pagination ${i === previewDataStore.currentPage ? 'active' : ''}" 
                    onclick="changePreviewPage(${i})">${i}</button>`;
            }
            
            if (endPage < previewDataStore.totalPages) {
                if (endPage < previewDataStore.totalPages - 1) {
                    paginationHTML += `<span>...</span>`;
                }
                paginationHTML += `<button class="btn-pagination" onclick="changePreviewPage(${previewDataStore.totalPages})">${previewDataStore.totalPages}</button>`;
            }
            
            // Next button
            paginationHTML += `<button class="btn-pagination" onclick="changePreviewPage(${previewDataStore.currentPage + 1})" 
                ${previewDataStore.currentPage === previewDataStore.totalPages ? 'disabled' : ''}>UrmƒÉtor ‚Ä∫</button>`;
            
            pagination.innerHTML = paginationHTML;
        }

        // Change preview page
        window.changePreviewPage = function(page) {
            if (page < 1 || page > previewDataStore.totalPages) return;
            
            previewDataStore.currentPage = page;
            loadPreviewPage();
        };

        // Load preview page (from server or filtered data)
        async function loadPreviewPage() {
            const table = document.getElementById('previewTable');
            table.innerHTML = '<div class="loading">Se √ÆncarcƒÉ...</div>';
            
            // If search is active, use filtered data
            const searchInput = document.getElementById('previewSearchInput');
            const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';
            
            if (searchTerm && previewDataStore.isInputFile && previewDataStore.filteredData.length > 0) {
                // Use filtered data for pagination
                const startIdx = (previewDataStore.currentPage - 1) * previewDataStore.rowsPerPage;
                const endIdx = startIdx + previewDataStore.rowsPerPage;
                const pageData = previewDataStore.filteredData.slice(startIdx, endIdx);
                renderPreviewTable(pageData, startIdx + 1);
                renderPagination();
                updatePreviewInfo();
                return;
            }
            
            // Load from server
            try {
                const response = await fetch(`/preview/${previewDataStore.folder}/${previewDataStore.filename}?page=${previewDataStore.currentPage}`);
                
                if (!response.ok) {
                    let errorText = await response.text();
                    try {
                        const errorData = JSON.parse(errorText);
                        throw new Error(errorData.error || 'Eroare necunoscutƒÉ');
                    } catch (parseError) {
                        throw new Error(`Eroare server: ${response.status} ${response.statusText}`);
                    }
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Serverul a returnat un rƒÉspuns nea»ôteptat.');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    previewDataStore.currentPage = data.current_page || 1;
                    previewDataStore.totalRows = data.total_rows || 0;
                    
                    // Set isOutputFile from backend or folder check
                    previewDataStore.isOutputFile = data.is_output_file !== undefined ? data.is_output_file : (previewDataStore.folder === 'outputs');
                    
                    // Calculate totalPages from total_rows if not provided correctly
                    if (previewDataStore.isOutputFile) {
                        previewDataStore.totalPages = 1;
                    } else if (data.total_pages && data.total_pages > 0) {
                        previewDataStore.totalPages = data.total_pages;
                    } else {
                        previewDataStore.totalPages = Math.ceil(previewDataStore.totalRows / (data.rows_per_page || 50));
                    }
                    
                    renderPreviewTable(data.data, data.start_row);
                    
                    // CRITICAL: Only render pagination for input files
                    const pagination = document.getElementById('previewPagination');
                    if (previewDataStore.isOutputFile) {
                        console.log('loadPreviewPage: HIDING PAGINATION FOR OUTPUT FILE');
                        if (pagination) {
                            pagination.style.display = 'none';
                            pagination.style.visibility = 'hidden';
                            pagination.innerHTML = '';
                            pagination.setAttribute('data-output-file', 'true');
                        }
                    } else {
                        console.log('loadPreviewPage: RENDERING PAGINATION FOR INPUT FILE');
                        if (pagination) {
                            pagination.removeAttribute('data-output-file');
                            pagination.style.visibility = 'visible';
                            renderPagination();
                        }
                    }
                    
                    updatePreviewInfo(data);
                } else {
                    throw new Error(data.error || 'E»ôec la √ÆncƒÉrcarea previzualizƒÉrii');
                }
            } catch (error) {
                table.innerHTML = `<div class="preview-error">Eroare: ${error.message}</div>`;
            }
        }

        // Update preview info
        function updatePreviewInfo(data = null) {
            const info = document.getElementById('previewInfo');
            const searchInput = document.getElementById('previewSearchInput');
            const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : '';
            
            let totalRows = previewDataStore.totalRows;
            let totalPages = previewDataStore.totalPages;
            let displayedRows = previewDataStore.isOutputFile ? Math.min(50, totalRows) : (data ? (data.end_row - data.start_row + 1) : 50);
            
            if (searchTerm && previewDataStore.isInputFile) {
                totalRows = previewDataStore.filteredData.length;
                totalPages = Math.ceil(totalRows / previewDataStore.rowsPerPage);
            }
            
            let previewInfo = `
                <div class="preview-meta">
                    <span><strong>Foaie:</strong> ${previewDataStore.sheetName}</span>
                    <span><strong>Total R√¢nduri:</strong> ${totalRows}</span>
                    <span><strong>Total Coloane:</strong> ${previewDataStore.totalColumns}</span>
            `;
            
            // For output files, show special message about limited preview
            if (previewDataStore.isOutputFile && totalRows > 50) {
                previewInfo += `<span style="color: var(--primary-color); font-weight: 600; display: block; margin-top: 8px; padding: 8px; background: rgba(74, 71, 138, 0.1); border-radius: 6px;">
                    ‚ö†Ô∏è Fi»ôier procesat: Total ${totalRows} r√¢nduri, se afi»ôeazƒÉ doar primele 50. DescƒÉrca»õi fi»ôierul pentru a vedea toate datele.
                </span>`;
            } else if (!previewDataStore.isOutputFile) {
                previewInfo += `<span><strong>Pagina:</strong> ${previewDataStore.currentPage} / ${totalPages}</span>`;
            }
            
            if (previewDataStore.has_more_columns) {
                previewInfo += `<span><strong>Coloane afi»ôate:</strong> ${previewDataStore.previewColumns} (din ${previewDataStore.totalColumns} total)</span>`;
            }
            
            if (searchTerm && previewDataStore.isInputFile) {
                previewInfo += `<span style="color: var(--primary-color); font-weight: 600;">üîç CƒÉutare activƒÉ: "${searchInput.value}" (${totalRows} rezultate)</span>`;
            }
            
            previewInfo += `</div>`;
            info.innerHTML = previewInfo;
        }

        // Search functionality (only for input files)
        function setupPreviewSearch() {
            const searchInput = document.getElementById('previewSearchInput');
            if (!searchInput) return;
            
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    if (!previewDataStore.isInputFile) return;
                    
                    const searchTerm = this.value.trim().toLowerCase();
                    
                    if (searchTerm === '') {
                        // Reset to original data
                        previewDataStore.filteredData = [];
                        previewDataStore.currentPage = 1;
                        loadPreviewPage();
                        return;
                    }
                    
                    // Filter data client-side
                    previewDataStore.filteredData = previewDataStore.allData.filter(row => {
                        return row.some(cell => {
                            const cellStr = String(cell || '').toLowerCase();
                            return cellStr.includes(searchTerm);
                        });
                    });
                    
                    // Reset to page 1 and recalculate pages
                    previewDataStore.currentPage = 1;
                    previewDataStore.totalPages = Math.ceil(previewDataStore.filteredData.length / previewDataStore.rowsPerPage);
                    
                    // Render filtered results
                    const startIdx = 0;
                    const endIdx = previewDataStore.rowsPerPage;
                    const pageData = previewDataStore.filteredData.slice(startIdx, endIdx);
                    renderPreviewTable(pageData, 1);
                    renderPagination();
                    updatePreviewInfo();
                }, 300); // Debounce 300ms
            });
        }

        async function previewFile(folder, filename) {
            console.log('=== PREVIEW FILE CALLED ===', { folder, filename });
            
            const modal = document.getElementById('previewModal');
            const title = document.getElementById('previewTitle');
            const info = document.getElementById('previewInfo');
            const table = document.getElementById('previewTable');
            const searchContainer = document.getElementById('previewSearchContainer');
            const searchInput = document.getElementById('previewSearchInput');
            const pagination = document.getElementById('previewPagination');
            
            // Reset state
            const isOutputFile = folder === 'outputs';
            const isInputFile = folder === 'uploads';
            
            console.log('File type check:', { folder, isOutputFile, isInputFile });
            
            previewDataStore = {
                allData: [],
                filteredData: [],
                currentPage: 1,
                totalPages: 1,
                rowsPerPage: 50,
                totalRows: 0,
                previewColumns: 0,
                totalColumns: 0,
                sheetName: '',
                filename: filename,
                folder: folder,
                isInputFile: isInputFile,
                isOutputFile: isOutputFile
            };
            
            console.log('previewDataStore initialized:', {
                folder: previewDataStore.folder,
                isOutputFile: previewDataStore.isOutputFile,
                isInputFile: previewDataStore.isInputFile
            });
            
            // Show/hide search based on file type
            if (previewDataStore.isInputFile) {
                searchContainer.style.display = 'block';
                if (searchInput) searchInput.value = '';
            } else {
                searchContainer.style.display = 'none';
            }
            
            // Show modal with loading state
            modal.style.display = 'flex';
            title.textContent = 'Se √ÆncarcƒÉ previzualizarea...';
            info.innerHTML = '';
            table.innerHTML = '<div class="loading">Se √ÆncarcƒÉ previzualizarea fi»ôierului...</div>';
            // Hide pagination initially, will be shown if needed for input files
            pagination.style.display = 'none';
            
            // For output files, hide pagination immediately
            console.log('Initial pagination check:', {
                isOutputFile: previewDataStore.isOutputFile,
                folder: previewDataStore.folder
            });
            
            if (previewDataStore.isOutputFile) {
                console.log('HIDING PAGINATION FOR OUTPUT FILE');
                pagination.style.display = 'none';
                pagination.style.visibility = 'hidden';
                pagination.setAttribute('data-output-file', 'true');
            } else {
                console.log('SHOWING PAGINATION FOR INPUT FILE');
                pagination.removeAttribute('data-output-file');
            }
            
            try {
                // Load first page
                const response = await fetch(`/preview/${folder}/${filename}?page=1`);
                
                if (!response.ok) {
                    let errorText = await response.text();
                    try {
                        const errorData = JSON.parse(errorText);
                        throw new Error(errorData.error || 'Eroare necunoscutƒÉ');
                    } catch (parseError) {
                        throw new Error(`Eroare server: ${response.status} ${response.statusText}`);
                    }
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    throw new Error('Serverul a returnat un rƒÉspuns nea»ôteptat.');
                }
                
                const data = await response.json();
                
                if (data.success) {
                    title.textContent = `Previzualizare: ${data.filename}`;
                    
                    // Store preview data
                    previewDataStore.sheetName = data.sheet_name;
                    previewDataStore.totalRows = data.total_rows;
                    previewDataStore.totalColumns = data.total_columns;
                    previewDataStore.previewColumns = data.preview_columns;
                    previewDataStore.has_more_columns = data.has_more_columns || false;
                    previewDataStore.currentPage = data.current_page || 1;
                    // Set isOutputFile from backend response or use folder check as fallback
                    previewDataStore.isOutputFile = data.is_output_file !== undefined ? data.is_output_file : (folder === 'outputs');
                    
                    console.log('=== AFTER DATA LOADED ===', {
                        folder: folder,
                        isOutputFile: previewDataStore.isOutputFile,
                        backendIsOutputFile: data.is_output_file,
                        totalRows: data.total_rows,
                        totalPages: data.total_pages
                    });
                    
                    // For output files, always 1 page (only first 50 rows shown)
                    // For input files, calculate totalPages from total_rows if not provided
                    if (previewDataStore.isOutputFile) {
                        previewDataStore.totalPages = 1;
                        console.log('OUTPUT FILE DETECTED - Setting totalPages to 1');
                    } else if (data.total_pages && data.total_pages > 0) {
                        previewDataStore.totalPages = data.total_pages;
                    } else {
                        // Calculate it ourselves from total_rows
                        previewDataStore.totalPages = Math.ceil(data.total_rows / (data.rows_per_page || 50));
                    }
                    
                    renderPreviewTable(data.data, data.start_row);
                    
                    // CRITICAL: Only render pagination for input files
                    console.log('About to check pagination:', {
                        isOutputFile: previewDataStore.isOutputFile,
                        folder: folder,
                        willRenderPagination: !previewDataStore.isOutputFile
                    });
                    
                    if (previewDataStore.isOutputFile) {
                        console.log('FORCING PAGINATION HIDE FOR OUTPUT FILE');
                        pagination.style.display = 'none';
                        pagination.style.visibility = 'hidden';
                        pagination.innerHTML = '';
                        pagination.setAttribute('data-output-file', 'true');
                    } else {
                        console.log('RENDERING PAGINATION FOR INPUT FILE');
                        pagination.removeAttribute('data-output-file');
                        pagination.style.visibility = 'visible';
                        renderPagination();
                    }
                    
                    updatePreviewInfo(data);
                    
                    // For input files, load all data for search in background (in chunks to avoid memory issues)
                    if (previewDataStore.isInputFile && data.total_rows <= 2000) {
                        // Load all data for files up to 2000 rows (don't await - load in background)
                        loadAllPreviewData(folder, filename, data.total_rows, data.total_pages).then(() => {
                            console.log('All preview data loaded for search');
                        }).catch(err => {
                            console.error('Error loading all preview data:', err);
                        });
                        
                        // Setup search if input file
                        setupPreviewSearch();
                    }
                } else {
                    title.textContent = 'Eroare Previzualizare';
                    info.innerHTML = '';
                    table.innerHTML = `<div class="preview-error">${data.error || 'E»ôec la √ÆncƒÉrcarea previzualizƒÉrii'}</div>`;
                }
            } catch (error) {
                title.textContent = 'Eroare Previzualizare';
                info.innerHTML = '';
                let errorMsg = error.message;
                if (errorMsg.includes("Unexpected token") || errorMsg.includes("JSON")) {
                    errorMsg = 'Fi»ôierul este prea mare sau serverul nu a putut procesa cererea.';
                }
                table.innerHTML = `<div class="preview-error">Eroare la √ÆncƒÉrcarea previzualizƒÉrii: ${errorMsg}</div>`;
            }
        }

        // Load all preview data for search (only for input files with reasonable size)
        async function loadAllPreviewData(folder, filename, totalRows, totalPages) {
            try {
                const allDataPromises = [];
                for (let page = 1; page <= Math.min(totalPages, 40); page++) { // Limit to 40 pages (2000 rows)
                    allDataPromises.push(
                        fetch(`/preview/${folder}/${filename}?page=${page}`)
                            .then(r => r.json())
                            .then(d => d.data || [])
                    );
                }
                
                const allPagesData = await Promise.all(allDataPromises);
                previewDataStore.allData = allPagesData.flat();
            } catch (error) {
                console.error('Error loading all preview data:', error);
                // Continue without search if loading fails
            }
        }

        function closePreview() {
            document.getElementById('previewModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('previewModal');
            if (event.target === modal) {
                closePreview();
            }
        }

        // Help section functions
        function toggleHelp() {
            const helpContent = document.getElementById('helpContent');
            const toggleBtn = document.querySelector('.btn-help-toggle');
            if (helpContent.style.display === 'none') {
                helpContent.style.display = 'block';
                toggleBtn.textContent = '‚àí';
            } else {
                helpContent.style.display = 'none';
                toggleBtn.textContent = '+';
            }
        }

        function showHelpTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.help-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.help-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`help${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
            event.target.classList.add('active');
        }

        function toggleFaq(element) {
            const faqItem = element.closest('.faq-item');
            const toggle = element.querySelector('.faq-toggle');
            
            // Check if this FAQ is already active
            const isActive = faqItem.classList.contains('active');
            
            // Close all FAQs first
            document.querySelectorAll('.faq-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelectorAll('.faq-toggle').forEach(tog => {
                tog.textContent = '+';
            });
            
            // If this FAQ wasn't active, open it
            if (!isActive) {
                faqItem.classList.add('active');
                toggle.textContent = '‚àí';
            }
        }
    </script>
</body>
</html>

